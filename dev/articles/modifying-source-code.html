<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Modifying torch source code • torch</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Modifying torch source code">
<meta name="robots" content="noindex">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-9ZJSKW3L0N"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9ZJSKW3L0N');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">torch</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.16.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/installation.html">Installation</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tensors</h6></li>
    <li><a class="dropdown-item" href="../articles/tensor-creation.html">Creating tensors</a></li>
    <li><a class="dropdown-item" href="../articles/indexing.html">Indexing</a></li>
    <li><a class="dropdown-item" href="../articles/tensor/index.html">Tensor class</a></li>
    <li><a class="dropdown-item" href="../articles/serialization.html">Serialization</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Datasets</h6></li>
    <li><a class="dropdown-item" href="../articles/loading-data.html">Loading Data</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Autograd</h6></li>
    <li><a class="dropdown-item" href="../articles/using-autograd.html">Using autograd</a></li>
    <li><a class="dropdown-item" href="../articles/extending-autograd.html">Extending autograd</a></li>
    <li><a class="dropdown-item" href="../articles/python-to-r.html">Python models</a></li>
    <li><a class="dropdown-item" href="../articles/torchscript.html">Jit Compilation</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples">
<li><a class="dropdown-item" href="../articles/examples/basic-autograd.html">basic-autograd</a></li>
    <li><a class="dropdown-item" href="../articles/examples/basic-nn-module.html">basic-nn-module</a></li>
    <li><a class="dropdown-item" href="../articles/examples/dataset.html">dataset</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-advanced" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Advanced</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-advanced">
<li><a class="dropdown-item" href="../articles/memory-management.html">Memory management</a></li>
    <li><a class="dropdown-item" href="../articles/compatibility-matrix.html">CUDA compatibility matrix</a></li>
    <li><a class="dropdown-item" href="../articles/modifying-source-code.html">Building locally</a></li>
    <li><a class="dropdown-item" href="../articles/amp.html">Automatic Mixed Precision</a></li>
    <li><a class="dropdown-item" href="../articles/modifying-source-code.html">Modifying source code</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlverse/torch/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Modifying torch source code</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlverse/torch/blob/main/vignettes/articles/modifying-source-code.Rmd" class="external-link"><code>vignettes/articles/modifying-source-code.Rmd</code></a></small>
      <div class="d-none name"><code>modifying-source-code.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The torch R package is composed of multiple abstraction layers until
R code finally calls LibTorch code. Depending on which part of the code
you want to modify you might need different build requirements for
setting up.</p>
<p>Because of some special requirements the project has, it’s not always
possible to use the standard <code>devtools</code> tools to work on
torch. This guide is intended for contributors to the torch codebase to
quickly get set up and be able to modify the source code without
spending too much time understanding the internals.</p>
<p>The torch R package is composed of the following layers, going top
down:</p>
<ol style="list-style-type: decimal">
<li>R code calling <code>torch_</code> functions.</li>
<li>R code calling <code>cpp_torch_</code> functions.</li>
<li>Rcpp (C++) code calling <code>lantern_torch_</code> functions.</li>
<li>Lantern (C++) code calling LibTorch functions.</li>
</ol>
<p>Depending on the function 2, 3 and 4. might be auto-generated (via
the tools/torchgen) package or not. In the next sections we will explain
how to contribute code depending on the layer you are modifying.</p>
</div>
<div class="section level2">
<h2 id="r-source-code">R source code<a class="anchor" aria-label="anchor" href="#r-source-code"></a>
</h2>
<p>Modifying R source code should be the simplest case and it shouldn’t
be required for contributors to other tools than the standard R
development toolbox (like RTools on Windows and a C++ compiler on
MacOS).</p>
<p>The standard <code>devtools</code> should just work too. Ie, you can
clone the project from GitHub, modify R source code, including
documentation and run <code>devtools::load_all()</code></p>
<p>The first time you run <code>devtools::load_all()</code>, the torch
installation prompt will appear and LibTorch and lantern binaries will
be downloaded and installed inside the <code>inst</code> directory of
your installation. Subsequent calls will work as expected.</p>
<blockquote>
<p><strong>Note</strong> loading torch twice without restarting the R
session causes the session to <strong>crash</strong>. Unbfortunatelly we
don’t know yet how to fix this bug and it’s related to problems with
correctly unloading shared libraries. So you should
<strong>restart</strong> your session before calling
<code>devtools::load_all()</code> again. Also <strong>note</strong> that
other functions might call <code>devtools::load_all()</code> internally,
like eg. <code>devtools::test()</code> and
<code>devtools::document()</code>.</p>
</blockquote>
<p>Also, running <strong>Build</strong> or <strong>Check</strong> in the
RStudio pane will fail, as it calls Rcpp::CompileAttributes without
calling the <code>Makevars</code> file instructions, that are required
for torch to work correctly.</p>
<p>If you use <code>devtools::check()</code> pass the argument
<code>devtools::check(document=FALSE)</code>. The reason for this is
described below.</p>
<div class="section level3">
<h3 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a>
</h3>
<p>torch registers a few roxygen2 roclets to handle examples and
sessions in roxygen2 documentation. Unfortunately we are unaware of any
method to automatically register these roclets without messing with the
DESCRIPTION’s collate field.</p>
<p>The recommended way to update documentation in torch is by using the
<code>tools/document.R</code> script. You can either call
<code>source("tools/document.R")</code> or, the recommended, run:</p>
<pre><code>Rscript tools/document.R</code></pre>
<p>in your terminal. This has the advantage that since
<code>devtools::document()</code> is called internally and it calls
<code><a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link">pkgload::load_all()</a></code>, that won’t crash your R session if you
forget to restart your session (see note above).</p>
</div>
</div>
<div class="section level2">
<h2 id="rcpp-code">Rcpp code<a class="anchor" aria-label="anchor" href="#rcpp-code"></a>
</h2>
<p>Modifying Rcpp source code in <code>src</code> should be very similar
to modifying C++ in other R packages.</p>
<p>You should pay attention when calling <code>lantern_*</code>
functions though. Most <code>lantern_*</code> functions return
<code>void*</code> that will leak the referring objects if they are not
correctly freed after use. The best way to handle them is to always
assign them to a variable with the correct type defined in
<code>inst/include/torch_types.h</code> specially those defined in the
C++ <code>namespace torch {}</code>. If you use these kind of objects
you also gain the ability to return them to R without having to write
custom Rcpp code as for most of them we have implemented the
<code>SEXP()</code> operator.</p>
</div>
<div class="section level2">
<h2 id="lantern-code">Lantern code<a class="anchor" aria-label="anchor" href="#lantern-code"></a>
</h2>
<p>In order to modify the Lantern source code you will first need to
make sure the environment variable <code>BUILD_LANTERN</code> is set to
<code>1</code>. To avoid forgetting to set it you can add it to your
<code>.Renviron</code> using, eg
<code>usethis::edit_r_environ()</code>.</p>
<p>That flag will trigger the <code>configure</code> file to call the
<code>lantern</code> target in Makevars. Building lantern requires CMake
to be in your path. You can install CMake in all major platforms by
following instructions in the <a href="https://cmake.org/install/" class="external-link">install page</a>.</p>
<p>When <code>BUILD_LANTERN=1</code> and you run
<code>devtools::load_all()</code>, Lantern will be compiled as part of
that workflow. You will see a new directory called
<code>build-lantern</code> in your package directory containing files
related to the Lantern build.</p>
<p>Lantern source code is located in <code>src/lantern/src</code>. The
lantern CMakeLists file is located at
<code>src/lantern/CMakeLists.txt</code>. You can also take a look at the
<code>lantern</code> target in <code>src/Makevars.in</code> to get a
sense of what CMake commands are called when building Lantern from
source.</p>
<p>By default, rebuilding Lantern is incremental, ie, calling
<code>devtools::load_all()</code> will only rebuild modified parts of
the Lantern code. Depending on the extend of your modifications in
Lantern source code you might need to completely clean the build
directory, you can do it by simply removing the
<code>build-lantern</code> directory.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel Falbel, Javier Luraschi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
