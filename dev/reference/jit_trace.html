<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Trace a function and return an executable script_function. — jit_trace • torch</title><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Trace a function and return an executable script_function. — jit_trace"><meta name="description" content="Using jit_trace, you can turn an existing R function into a TorchScript
script_function. You must provide example inputs, and we run the function,
recording the operations performed on all the tensors."><meta property="og:description" content="Using jit_trace, you can turn an existing R function into a TorchScript
script_function. You must provide example inputs, and we run the function,
recording the operations performed on all the tensors."><meta name="robots" content="noindex"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-9ZJSKW3L0N"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9ZJSKW3L0N');
</script></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">torch</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.16.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/installation.html">Installation</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tensors</h6></li>
    <li><a class="dropdown-item" href="../articles/tensor-creation.html">Creating tensors</a></li>
    <li><a class="dropdown-item" href="../articles/indexing.html">Indexing</a></li>
    <li><a class="dropdown-item" href="../articles/tensor/index.html">Tensor class</a></li>
    <li><a class="dropdown-item" href="../articles/serialization.html">Serialization</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Datasets</h6></li>
    <li><a class="dropdown-item" href="../articles/loading-data.html">Loading Data</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Autograd</h6></li>
    <li><a class="dropdown-item" href="../articles/using-autograd.html">Using autograd</a></li>
    <li><a class="dropdown-item" href="../articles/extending-autograd.html">Extending autograd</a></li>
    <li><a class="dropdown-item" href="../articles/python-to-r.html">Python models</a></li>
    <li><a class="dropdown-item" href="../articles/torchscript.html">Jit Compilation</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples"><li><a class="dropdown-item" href="../articles/examples/basic-autograd.html">basic-autograd</a></li>
    <li><a class="dropdown-item" href="../articles/examples/basic-nn-module.html">basic-nn-module</a></li>
    <li><a class="dropdown-item" href="../articles/examples/dataset.html">dataset</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-advanced" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Advanced</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-advanced"><li><a class="dropdown-item" href="../articles/memory-management.html">Memory management</a></li>
    <li><a class="dropdown-item" href="../articles/compatibility-matrix.html">CUDA compatibility matrix</a></li>
    <li><a class="dropdown-item" href="../articles/modifying-source-code.html">Building locally</a></li>
    <li><a class="dropdown-item" href="../articles/amp.html">Automatic Mixed Precision</a></li>
    <li><a class="dropdown-item" href="../articles/modifying-source-code.html">Modifying source code</a></li>
  </ul></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlverse/torch/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Trace a function and return an executable <code>script_function</code>.</h1>
      <small class="dont-index">Source: <a href="https://github.com/mlverse/torch/blob/main/R/trace.R" class="external-link"><code>R/trace.R</code></a></small>
      <div class="d-none name"><code>jit_trace.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Using <code>jit_trace</code>, you can turn an existing R function into a TorchScript
<code>script_function</code>. You must provide example inputs, and we run the function,
recording the operations performed on all the tensors.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">jit_trace</span><span class="op">(</span><span class="va">func</span>, <span class="va">...</span>, strict <span class="op">=</span> <span class="cn">TRUE</span>, respect_mode <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-func">func<a class="anchor" aria-label="anchor" href="#arg-func"></a></dt>
<dd><p>An R function that will be run with <code>example_inputs</code>. func arguments
and return values must be tensors or (possibly nested) lists that contain tensors.
Can also be a <code><a href="nn_module.html">nn_module()</a></code>, in such case <code><a href="jit_trace_module.html">jit_trace_module()</a></code> is used to trace
that module.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>example inputs that will be passed to the function while
tracing. The resulting trace can be run with inputs of different types and
shapes assuming the traced operations support those types and shapes.
<code>example_inputs</code> may also be a single Tensor in which case it is automatically
wrapped in a list. Note that <code>...</code> <strong>can not</strong> be named, and the order is
respected.</p></dd>


<dt id="arg-strict">strict<a class="anchor" aria-label="anchor" href="#arg-strict"></a></dt>
<dd><p>run the tracer in a strict mode or not (default: <code>TRUE</code>). Only
turn this off when you want the tracer to record your mutable container types
(currently list/dict) and you are sure that the container you are using in
your problem is a constant structure and does not get used as control flow
(<code>if</code>, <code>for</code>) conditions.</p></dd>


<dt id="arg-respect-mode">respect_mode<a class="anchor" aria-label="anchor" href="#arg-respect-mode"></a></dt>
<dd><p>(<code>logical(1)</code>)<br>
Whether both modes ('train' or 'eval') should be traced. If <code>TRUE</code> (default),
the underlying C++ ScriptModule will have two methods <code>trainforward()</code> and
<code>evalforward()</code>.
The <code>$forward()</code> method of the R torch module will then select either based
on the mode.
If <code>FALSE</code>, only the current mode of the module will be jitted and hence only
one <code>forward()</code> method exists.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An <code>script_function</code> if <code>func</code> is a function and <code>script_module</code> if
<code>func</code> is a <code><a href="nn_module.html">nn_module()</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The resulting recording of a standalone function produces a <code>script_function</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="warning">Warning<a class="anchor" aria-label="anchor" href="#warning"></a></h2>



<p>Tracing only correctly records functions and modules which are not data dependent
(e.g., do not have conditionals on data in tensors) and do not have any untracked
external dependencies (e.g., perform input/output or access global variables).
Tracing only records operations done when the given function is run on the given
tensors. Therefore, the returned <code>script_function</code> will always run the same traced
graph on any input. This has some important implications when your module is
expected to run different sets of operations, depending on the input and/or the
module state. For example,</p><ul><li><p>Tracing will not record any control-flow like if-statements or loops. When
this control-flow is constant across your module, this is fine and it often
inlines the control-flow decisions. But sometimes the control-flow is actually
part of the model itself. For instance, a recurrent network is a loop over
the (possibly dynamic) length of an input sequence.</p></li>
<li><p>In the returned <code>script_function</code>, operations that have different behaviors
in training and eval modes will always behave as if it is in the mode it was
in during tracing, no matter which mode the <code>script_function</code> is in.</p></li>
</ul><p>In cases like these, tracing would not be appropriate and scripting is a better
choice. If you trace such models, you may silently get incorrect results on
subsequent invocations of the model. The tracer will try to emit warnings when
doing something that may cause an incorrect trace to be produced.
For scripting, see <code><a href="jit_compile.html">jit_compile</a></code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="torch_is_installed.html">torch_is_installed</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="torch_relu.html">torch_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">tr_fn</span> <span class="op">&lt;-</span> <span class="fu">jit_trace</span><span class="op">(</span><span class="va">fn</span>, <span class="va">input</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">tr_fn</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> torch_tensor</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [ CPUFloatType{3} ]</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel Falbel, Javier Luraschi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

